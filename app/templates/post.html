{% extends 'base8-4.html' %}
{% import '_macros.html' as macros %}

{% block title %} 帖子 - {{ post.title }}{% endblock %}

{% block page_content %}
    {% set title = post.title %}
    {% set content = post.content %}
    {% set author = post.author.username %}
    <div class="row">
        <div class="col-md-12 post-detail-content">
            <div class="post-detail-title">
                {{ title }}
            </div>
            <div class="post-detail-body">
                {{ content }}
            </div>
            <div class="post-detail-info">
                作者： {{ author }} &nbsp; | &nbsp; 发表于： {{ post.created_time | format_time }} &nbsp; | &nbsp; 最后更新于：
            </div>
        </div>

        <div class="col-md-12 comment-list">
            {% set comment_count = comments.__len__() %}
            <div class="comment-list-header">
                {{ comment_count }}条回复
            </div>
            {% if comment_count > 0 %}
            <div class="comment-list-body" id="id-text-commentbody">
                {% include "_comments.html" %}
            </div>
            {% endif %}
        </div>
    </div>
    {% if current_user is not none %}
    <div class="comment-form">
        <form class="form-horizontal">
        <div class="col-lg-10">

        </div>&nbsp;
        </form>
        <p id='id-p-info'></p>
        <input id="id-text-content" class="form-control input-lg" name="content" placeholder="说点什么...">
        <button id="id-button-submitcomment" type="submit" class="btn btn-fill btn-middle btn-lg">发表</button>
    </div>
    {% endif %}
{% endblock %}

{% block script %}
{{ super() }}
<script>
    $('#id-button-submitcomment').on('click', function(){
      var url = '/add_comment';
      var commentContent = $('#id-text-content').val();
      var data = {
        content: commentContent,
        postId: {{ post.id }},
      };
      postData = JSON.stringify(data);
      var request = {
        url: url,
        data: postData,
        type: 'post',
        contentType: 'application/json',
        success: function(data) {
          var resp = data
          console.log('服务器返回的数据是', resp);
          $('#id-p-info').text(resp.msg);
          if (resp.success) {
            var comment = resp.data
            var commentHTML = (
            `
              <div class="col-md-12 item-container comment-container">
                  <div class="row">
                      <div class="col-md-12">
                          <div class="col-md-2 comment-left">
                              <div class="item-portrait">
                                  <img class="img-rounded center-block round" src="${ comment.author.portrait }" />
                              </div>
                              <div class="item-author">
                                  <a href="/profile/${ comment.author.username }">${ comment.author.username }</a>
                              </div>
                          </div>
                          <div class="col-md-10 comment-right">
                              ${ comment.content }
                          </div>
                      </div>
                      <div class="col-md-12 item-footer comment-footer">
                          <a href="#">编辑</a> &nbsp; |&nbsp;
                          <a href="#">删除</a> &nbsp; |&nbsp;
                          发表于： ${ comment.created_time }
                      </div>
                  </div>
              </div>
            `
            );
            $('#id-text-commentbody').append(commentHTML);
          }
        }
      };
      $.ajax(request)
    });
</script>
{% endblock %}
